<html>
  <!-- <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }

    td,
    th {
      border: 1px solid #000000;
      text-align: left;
      padding: 8px;
    }

    tr:nth-child(even) {
      background-color: #dddddd;
    }
  </style> -->
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />
    <link
      href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css"
      rel="stylesheet"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"
    ></script>
    <title>Tables</title>
    <script src="/rtl/jquery.js"></script>
    <script src="/rtl/smq.js"></script>
    <script>
      const split = window.location.href.split("/");
      const currentUrl = split[split.length - 1];

      console.log(currentUrl);

      $(function () {
        var smq = SMQ.Client(SMQ.wsURL("/QPCSBroker/"));
        // var smq = SMQ.Client("wss://simplemq.com/smq.lsp");

        function insertRows() {
          var seconds = 0;
          var interval = setInterval(function () {
            seconds++;
            const curRow = {
              time: seconds.toString(),
              state: "inter_obs",
              elapsed: seconds.toString(),
            };

            smq.pubjson(curRow, "tableView");

            if (seconds > 20) {
              clearInterval(interval);
            }
          }, 1000);

          return false;
        }

        //create Tabulator on DOM element with id "example-table"
        var table = new Tabulator("#example-table", {
          height: 200, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
          // data: tabledata, //assign data to table
          // layout: "fitColumns", //fit columns to width of table (optional)
          columns: [
            //Define Table Columns
            {
              title: "Time",
              field: "time",
              hozAlign: "center",
              width: 450,
            },
            {
              title: "State",
              field: "state",
              hozAlign: "center",
              width: 450,
            },
            {
              title: "Elapsed",
              field: "elapsed",
              hozAlign: "center",
              width: 480,
            },
          ],
        });

        function onValueUpdate(msg, ftid) {
          table.addData(
            [{ time: msg.time, state: msg.state, elapsed: msg.elapsed }],
            false
          );
        }

        //trigger an alert message when the row is clicked
        table.on("rowClick", function (e, row) {
          alert("Row " + row.getData().id + " Clicked!!!!");
        });

        smq.subscribe("tableView", { onmsg: onValueUpdate, datatype: "json" });

        function onNavNames(msg, ftid) {
          const navList = document.getElementsByClassName("nav__list")[0];
          for (let i = 0; i < msg.length; i++) {
            const navItem = document.createElement("li");
            navItem.className = "nav__item";
            const aElement = document.createElement("a");
            aElement.className = "nav__link";
            if (msg[i].href === ".") {
              aElement.className = "active";
            }

            aElement.textContent = msg[i].name;

            aElement.href = msg[i].href;

            navItem.append(aElement);
            navList.append(navItem);
          }
        }

        smq.subscribe("nav_items_response", {
          onmsg: onNavNames,
          datatype: "json",
        });

        smq.publish("signal", "nav_names_request");

        $("#table").click(insertRows);
      });
    </script>
  </head>

  <body>
    <header class="header">
      <div class="header__content">
        <!-- <a class="logo"> </a> -->
        <nav class="nav">
          <ul class="nav__list"></ul>
        </nav>
      </div>
    </header>
    <h1 style="margin-left: 3%; margin-top: 2%; margin-bottom: 2%">
      ESS Viewer
    </h1>

    <button class="experimentButton" id="table">Go</button>

    <div id="example-table" style="margin: 3%; height: 500px"></div>
  </body>
</html>
