<html>
  <!-- <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }

    td,
    th {
      border: 1px solid #000000;
      text-align: left;
      padding: 8px;
    }

    tr:nth-child(even) {
      background-color: #dddddd;
    }
  </style> -->
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />
    <link
      href="https://unpkg.com/tabulator-tables/dist/css/tabulator.min.css"
      rel="stylesheet"
    />
    <script
      type="text/javascript"
      src="https://unpkg.com/tabulator-tables/dist/js/tabulator.min.js"
    ></script>
    <title>Tables</title>
    <script src="/rtl/jquery.js"></script>
    <script src="/rtl/smq.js"></script>
    <script>
      const split = window.location.href.split("/");
      const currentUrl = split[split.length - 1];

      // Create an object to store directories that have been created already
      const directoryMap = {};

      $(function () {
        var smq = SMQ.Client(SMQ.wsURL("/QPCSBroker/"));
        // var smq = SMQ.Client("wss://simplemq.com/smq.lsp");

        //create Tabulator on DOM element with id "example-table"
        var table = new Tabulator("#example-table", {
          height: 200, // set height of table (in CSS or here), this enables the Virtual DOM and improves render speed dramatically (can be any valid css height value)
          // data: tabledata, //assign data to table
          // layout: "fitColumns", //fit columns to width of table (optional)
          columns: [
            //Define Table Columns
            {
              title: "Time",
              field: "time",
              hozAlign: "center",
              width: 450,
            },
            {
              title: "Name",
              field: "name",
              hozAlign: "center",
              width: 450,
            },
            {
              title: "Data",
              field: "data",
              hozAlign: "center",
              width: 480,
            },
          ],
        });

        function onValueUpdate(msg, ftid) {
          table.addData(
            [{ time: msg.time, name: msg.name, data: msg.data }],
            false
          );
        }

        //trigger an alert message when the row is clicked
        table.on("rowClick", function (e, row) {
          alert("Row " + row.getData().id + " Clicked!!!!");
        });



        // smq.subscribe("tableView", { onmsg: onValueUpdate, datatype: "json" });

        function onNavNames(msg, ftid) {
          const navList = document.getElementsByClassName("nav__list")[0];
          for (let i = 0; i < msg.length; i++) {
            const navItem = document.createElement("li");
            navItem.className = "nav__item";
            const aElement = document.createElement("a");
            aElement.className = "nav__link";
            if (msg[i].href === currentUrl) {
              aElement.className = "active";
            }

            aElement.textContent = msg[i].name;

            aElement.href = msg[i].href;

            navItem.append(aElement);
            navList.append(navItem);
          }
        }

        function onDeviceName(msg, ftid) {
          console.log(msg);
          const fileName = msg.fileName; // Extract file name from path
          const filePath = msg.filePath;
          const key = msg.key;

          const directories = filePath.split("/").slice(0, -1);

          var uiElement = $(".treeContainer");
          var spacing = 0;

          if (directories.length !== 0) {
            directories.forEach((directory) => {
              if (!directoryMap[directory]) {
                //if directory not rendered yet

                const directoryName = document.createElement("div");
                directoryName.setAttribute("data-directory", directory);
                directoryName.innerHTML =
                  "&#9656; " + directoryName.getAttribute("data-directory"); //right

                directoryName.style.marginLeft = spacing;

                const directoryList = document.createElement("sidebar");

                directoryName.addEventListener("click", function () {
                  if (directoryList.style.display === "none") {
                    directoryList.style.display = "block";
                    directoryName.innerHTML =
                      "&#9662; " + directoryName.getAttribute("data-directory"); //down
                  } else {
                    directoryList.style.display = "none";
                    directoryName.innerHTML =
                      "&#9656; " + directoryName.getAttribute("data-directory"); //right
                  }
                });

                directoryList.style.display = "none";
                uiElement.append(directoryName);
                uiElement.append(directoryList);
                uiElement = directoryList;
                directoryMap[directory] = uiElement;
              }

              uiElement = directoryMap[directory];
              spacing += 10;
            });
          }

          const button = document.createElement("div");
          // button.textContent = fileName;
          button.className = "deviceCheckbox";

          
   
          
          button.style.marginLeft = spacing;

          const deviceCheckbox = document.createElement("input");
          deviceCheckbox.type = "checkbox";
          deviceCheckbox.textContent = fileName;

          deviceCheckbox.addEventListener("click", function() {

            if (deviceCheckbox.checked){
              smq.subscribe(fileName+"tableView", {
                onmsg: onValueUpdate,
                datatype: "json",
              });

            }
            else{
              smq.unsubscribe(fileName+"tableView");
            }
          });
          

          


          const checkboxLabel = document.createElement("label");
          checkboxLabel.textContent = fileName + ":";

          deviceCheckbox.style.marginLeft = 5
          button.append(checkboxLabel)

          button.append(deviceCheckbox)

          const hiddenBox = document.createElement("div");
          hiddenBox.textContent = fileName

          hiddenBox.className = "hiddenBox"
          hiddenBox.id = "hiddenBox"+fileName

          button.append(hiddenBox)

          button.addEventListener('mouseover', function() {

            smq.publish(fileName, "device_check_request");
            hiddenBox.style.display = 'block';
          });

          button.addEventListener('mouseout', function() {

            hiddenBox.style.display = 'none';
          });

          button.setAttribute("data-filename", fileName); // Set data attribute for filename
          button.setAttribute("data-key", key); // Set data attribute for key

          uiElement.append(button);
        }

        function onDeviceCheck(msg, ftid){
          const hbox = document.getElementById("hiddenBox"+msg.fileName)
          hbox.textContent = msg.fileName + " status: " + msg.data
        
        }


        smq.subscribe("device_check_response", {
            onmsg: onDeviceCheck,
            datatype: "json",
        })

        smq.subscribe("device_names_response", {
          onmsg: onDeviceName,
          datatype: "json",
        });

        smq.publish("signal", "device_names_request");

        smq.subscribe("nav_items_response", {
          onmsg: onNavNames,
          datatype: "json",
        });

        smq.publish("signal", "nav_names_request");
      });
    </script>
  </head>

  <body>
    <header class="header">
      <div class="header__content">
        <!-- <a class="logo"> </a> -->
        <nav class="nav">
          <ul class="nav__list"></ul>
        </nav>
      </div>
    </header>


    <div class="treeContainer" ><h3 >Display options:</h1></div>

    <div id="example-table" style="margin: 3%; height: 500px"></div>
  </body>
</html>
