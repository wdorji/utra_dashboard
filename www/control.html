<html>
  <!-- <style>
    table {
      font-family: arial, sans-serif;
      border-collapse: collapse;
      width: 100%;
    }

    td,
    th {
      border: 1px solid #000000;
      text-align: left;
      padding: 8px;
    }

    tr:nth-child(even) {
      background-color: #dddddd;
    }
  </style> -->
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />

    <title>Tables</title>
    <script src="/rtl/jquery.js"></script>
    <script src="/rtl/smq.js"></script>
    <script>
      const split = window.location.href.split("/");
      const currentUrl = split[split.length - 1];

      $(function () {
        var smq = SMQ.Client(SMQ.wsURL("/QPCSBroker/"));

        function onNavNames(msg, ftid) {
          const navList = document.getElementsByClassName("nav__list")[0];
          for (let i = 0; i < msg.length; i++) {
            const navItem = document.createElement("li");
            navItem.className = "nav__item";
            const aElement = document.createElement("a");
            aElement.className = "nav__link";
            if (msg[i].href === currentUrl) {
              aElement.className = "active";
            }

            aElement.textContent = msg[i].name;

            aElement.href = msg[i].href;

            navItem.append(aElement);
            navList.append(navItem);
          }
        }

        smq.subscribe("nav_items_response", {
          onmsg: onNavNames,
          datatype: "json",
        });

        smq.publish("signal", "nav_names_request");

        function onParameters(msg, ftid) {
          const controlGrid = document.getElementsByClassName("controlGrid")[0];
          const uncategorised = [];
          const categorised = new Map();
          const categories = [];

          console.log(msg);

          for (let i = 0; i < msg.length; i++) {
            if (!msg[i].category) {
              uncategorised.push(msg[i]);
            } else if (categorised.has(msg[i].category)) {
              categorised.get(msg[i].category).push(msg[i]);
              categories.push(msg[i].category);
            } else {
              categorised.set(msg[i].category, [msg[i]]);
            }
          }

          if (uncategorised.length > 0) {
            const uncategorisedGrid = document.createElement("div");
            uncategorisedGrid.className = "uncategorisedGrid";

            const uncategorisedWrapper = document.createElement("div");

            for (let i = 0; i < uncategorised.length; i++) {
              const widgetData = uncategorised[i];

              if (widgetData.widgetType === "dropdown") {
                const widgetContainer = document.createElement("div");
                widgetContainer.className = "widgetContainer";

                const dropdownLabel = document.createElement("label");
                dropdownLabel.textContent = widgetData.name + ":";

                widgetContainer.append(dropdownLabel);

                const dropdownSelect = document.createElement("select");

                widgetData.options.forEach((element) => {
                  const curOption = document.createElement("option");
                  curOption.value = element;
                  curOption.textContent = element;
                  dropdownSelect.append(curOption);
                });
                widgetContainer.append(dropdownSelect);

                uncategorisedGrid.append(widgetContainer);
              } else if (widgetData.widgetType === "range") {
                const sliderContainer = document.createElement("div");
                sliderContainer.className = "sliderContainer";

                const sliderLabel = document.createElement("label");
                sliderLabel.textContent =
                  widgetData.name + ": " + widgetData.value;

                sliderContainer.append(sliderLabel);
                const rangeWrapper = document.createElement("div");
                const slider = document.createElement("input");
                slider.type = "range";
                slider.id = widgetData.name + "_range";
                slider.min = widgetData.min;
                slider.max = widgetData.max;
                slider.value = widgetData.value;
                slider.step = widgetData.step;

                rangeWrapper.append(slider);

                sliderContainer.append(rangeWrapper);

                const rangeBounds = document.createElement("div");
                rangeBounds.className = "boundsWrapper";

                const upperBound = document.createElement("p");
                upperBound.id = widgetData.name + "_max";
                upperBound.textContent = widgetData.max;

                const lowerBound = document.createElement("p");
                lowerBound.id = widgetData.name + "_min";
                lowerBound.textContent = widgetData.min;
                rangeBounds.append(lowerBound);
                rangeBounds.append(upperBound);
                sliderContainer.append(rangeBounds);

                slider.oninput = function () {
                  sliderLabel.textContent = widgetData.name + ": " + this.value;
                };

                uncategorisedWrapper.append(sliderContainer);
              } else {
                const widgetContainer = document.createElement("div");
                widgetContainer.className = "widgetContainer";

                const widgetLabel = document.createElement("label");
                widgetLabel.textContent = widgetData.name + ":";

                widgetContainer.append(widgetLabel);

                const widgetInput = document.createElement("input");
                widgetInput.type = widgetData.widgetType;

                if (widgetInput.type == "text") {
                  console.log(
                    widgetData.placeholder,
                    typeof widgetData.placeholder
                  );
                  widgetInput.placeholder = widgetData.placeholder;
                } else {
                  widgetInput.checked = widgetData.checked;
                }

                widgetContainer.append(widgetInput);

                uncategorisedGrid.append(widgetContainer);
              }
            }
            uncategorisedWrapper.append(uncategorisedGrid);
            controlGrid.append(uncategorisedWrapper);
          }

          if (categories.length > 0) {
            for (let c = 0; c < categories.length; c++) {
              const curCategory = categories[c];

              const categoryGrid = document.createElement("div");
              categoryGrid.className = "categoryGrid";

              const categoryWrapper = document.createElement("div");
              categoryWrapper.className = "categoryWrapper";

              const categoryWidgets = categorised.get(curCategory);

              for (let i = 0; i < categoryWidgets.length; i++) {
                const widgetData = categoryWidgets[i];

                if (widgetData.widgetType === "dropdown") {
                  const widgetContainer = document.createElement("div");
                  widgetContainer.className = "widgetContainer";

                  const dropdownLabel = document.createElement("label");
                  dropdownLabel.textContent = widgetData.name + ":";

                  widgetContainer.append(dropdownLabel);

                  const dropdownSelect = document.createElement("select");

                  widgetData.options.forEach((element) => {
                    const curOption = document.createElement("option");
                    curOption.value = element;
                    curOption.textContent = element;
                    dropdownSelect.append(curOption);
                  });
                  widgetContainer.append(dropdownSelect);

                  categoryGrid.append(widgetContainer);
                } else if (widgetData.widgetType === "range") {
                  const sliderContainer = document.createElement("div");
                  sliderContainer.className = "sliderContainer";

                  const sliderLabel = document.createElement("label");
                  sliderLabel.textContent =
                    widgetData.name + ": " + widgetData.value;

                  sliderContainer.append(sliderLabel);
                  const rangeWrapper = document.createElement("div");
                  const slider = document.createElement("input");
                  slider.type = "range";
                  slider.id = widgetData.name + "_range";
                  slider.min = widgetData.min;
                  slider.max = widgetData.max;
                  slider.value = widgetData.value;
                  slider.step = widgetData.step;

                  rangeWrapper.append(slider);

                  sliderContainer.append(rangeWrapper);

                  const rangeBounds = document.createElement("div");
                  rangeBounds.className = "boundsWrapper";

                  const upperBound = document.createElement("p");
                  upperBound.id = widgetData.name + "_max";
                  upperBound.textContent = widgetData.max;

                  const lowerBound = document.createElement("p");
                  lowerBound.id = widgetData.name + "_min";
                  lowerBound.textContent = widgetData.min;
                  rangeBounds.append(lowerBound);
                  rangeBounds.append(upperBound);
                  sliderContainer.append(rangeBounds);

                  slider.oninput = function () {
                    sliderLabel.textContent =
                      widgetData.name + ": " + this.value;
                  };

                  categoryWrapper.append(sliderContainer);
                } else {
                  const widgetContainer = document.createElement("div");
                  widgetContainer.className = "widgetContainer";

                  const widgetLabel = document.createElement("label");
                  widgetLabel.textContent = widgetData.name + ":";

                  widgetContainer.append(widgetLabel);

                  const widgetInput = document.createElement("input");
                  widgetInput.type = widgetData.widgetType;

                  if (widgetInput.type == "text") {
                    console.log(
                      widgetData.placeholder,
                      typeof widgetData.placeholder
                    );
                    widgetInput.placeholder = widgetData.placeholder;
                  } else {
                    widgetInput.checked = widgetData.checked;
                  }

                  widgetContainer.append(widgetInput);

                  categoryGrid.append(widgetContainer);
                }
              }
              categoryWrapper.append(categoryGrid);
              controlGrid.append(categoryWrapper);
            }
          }
        }

        smq.subscribe("parameters_response", {
          onmsg: onParameters,
          datatype: "json",
        });

        smq.publish("signal", "parameters_request");
      });
    </script>
  </head>

  <body>
    <header class="header">
      <div class="header__content">
        <!-- <a class="logo"> </a> -->

        <nav class="nav">
          <ul class="nav__list"></ul>
        </nav>
      </div>
    </header>
    <h1 style="margin: 3%">Control Viewer</h1>
    <div class="controlWrapper">
      <div class="controlGrid">
        <!-- <div class="categoryWrapper">
          <div class="sliderContainer">
            <label for="system">Slider1:</label>
            <div class="range-wrap">
              <div class="range-value" id="rangeV"></div>
              <input
                id="range"
                type="range"
                min="200"
                max="800"
                value="200"
                step="1"
              />
            </div>

            <div class="boundsWrapper">
              <p id="minVal">0</p>
              <p id="maxVal">100</p>
            </div>
          </div>

          <div class="categoryGrid">
            <div class="widgetContainer">
              <label>Input1:</label>

              <input type="text" />
            </div>
            <div class="widgetContainer">
              <label>Check1:</label>

              <input type="checkbox" />
            </div>
            <div class="widgetContainer">
              <label>Dropdown1:</label>
              <select name="system" id="system">
                <option value="Option1">Option1</option>
                <option value="Option2">Option2</option>
                <option value="Option3">Option3</option>
              </select>
            </div>
          </div>
        </div> -->
      </div>
    </div>
  </body>
</html>
