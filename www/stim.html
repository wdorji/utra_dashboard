<html>
  <style>
    /* Set editor dimensions */
    #editor {
      height: 100%;
      width: 98%;
      margin: 1%;
    }

    #command {
      height: 30px;
      width: 98%;
      margin: 1%;
    }
    #console {
      height: 180px;
      width: 98%;
      margin: 1%;
    }

    /* Stretch editor to fit inside its containing div */
    .cm-editor {
      height: 100%;
      width: 100%;
    }
  </style>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />

    <title>STIM</title>
    <script src="/rtl/jquery.js"></script>
    <script src="/rtl/smq.js"></script>
    <script>
      $(function () {

        let states = new Map(); //map to hold editor states for each file

        let initStates = new Map(); //map to store initial editor states for each file
        const emptyState = cm6.createEditorState("");
        var latestFilename = "";
        var latestKey = ""
        var latestContent = "";
        var tabs = []//array holding current tabs that are rendered

        // Create an object to store directories that have been created already
        const directoryMap = {};

        var smq = SMQ.Client(SMQ.wsURL("/QPCSBroker/"));

        var revertState = cm6.createEditorState("");

        //hide editors initially
        document.getElementById("editor").style.display =  "none"


        // Add an event listener to save temporary changes in editor
        document.getElementById("editor").addEventListener("keyup", function() {
          console.log("change detected")
          console.log(view.state)
          // Save state typed into the textarea
          states.set(latestKey, view.state)

          //check if there is a change

          var unmodified = true
          
          if  (view.state.doc.text.length == initStates.get(latestKey).doc.text.length){
            for (let i=0; i<view.state.doc.text.length; i++){
              if (view.state.doc.text[i] !== initStates.get(latestKey).doc.text[i]){//modified content
                unmodified = false
                break
              }
             
            }
          }

          else{//change in number of lines
            unmodified = false
          }

          console.log(unmodified)

          if (!unmodified){
            const fileButtons = document.getElementsByClassName("fileButton")
            for (let i=0; i<fileButtons.length; i++){
              if (fileButtons[i].getAttribute("data-key") == latestKey){
                fileButtons[i].textContent = "* "+ latestFilename
              }
             
            }
          }
          else{
            const fileButtons = document.getElementsByClassName("fileButton")
            for (let i=0; i<fileButtons.length; i++){
              if (fileButtons[i].getAttribute("data-key") == latestKey){
                fileButtons[i].textContent = latestFilename
              }
             
            }
          }
          
        });

         // Add an event listener to evaluate command
        document.getElementById("command").addEventListener("keyup", function() {

          if (event.key === "Enter") {
            //evaluate command
            console.log(commandView.state.doc.text[0])
            smq.publish(commandView.state.doc.text[0], "evaluate_command_request");
            commandView.setState(emptyState)
          }
        });

    
        function setFileContentState(fileName, key) {
          console.log("setting", key)

          //request data from server
          const script  = {
              fileName: fileName,
              key: key,
            };
          
          smq.pubjson(script, "file_content_request");

        }


        //update editor state to files current state
        function handleFileButtonClick(fileName, key) {

          latestFilename = fileName;
          latestKey = key


          //make current selected tab active color
          const tabElements = document.getElementsByClassName("tablinks")[0].children
          for (let i=0;i<tabElements.length;i++){
            const curButtonComponent = tabElements[i]
            curButtonComponent.classList.remove("active")
            if (curButtonComponent.getAttribute("data-key") == key){
              curButtonComponent.classList.add("active")
            }
          }

          if (states.has(key)){
            console.log("Settng from map")
            view.setState(states.get(key));
          }
          
          
        }

        function createTabButton(fileName, key){
          

          var index = tabs.indexOf(key);
          if (index === -1) { // if tab is not yet created

            const tabElements = document.getElementsByClassName("tablinks")

            tabs.push(key)
            const tabButtonComponent = document.createElement("div");
            tabButtonComponent.className = "buttons-wrapper"
            tabButtonComponent.setAttribute("data-filename", fileName);
            tabButtonComponent.setAttribute("data-key", key);


            const tabOpenButton = document.createElement("button");
            tabOpenButton.innerHTML = fileName
            
            tabOpenButton.addEventListener("click", function() {
              handleFileButtonClick(fileName, key)
            });

            const tabCloseButton = document.createElement("button");
            tabCloseButton.innerHTML = "&#x2715;"

            tabCloseButton.addEventListener("click", function() {

              const fileButtons = document.getElementsByClassName("fileButton")
              for (let i=0; i<fileButtons.length; i++){
                if (fileButtons[i].getAttribute("data-key") == latestKey){
                  if (fileButtons[i].textContent == "* "+ latestFilename){

                    if (confirm('You have unsaved changes. Click "OK" to save changes and "Cancel" to not save changes.')) {
                      // Save changes
                      saveCurrentContent()
                      
                    } else {
                      // Do nothing!
                      console.log('Thing was not saved to the database.');
                    }
                    fileButtons[i].textContent = latestFilename

                  }
                  
                }
              
              }
              index = tabs.indexOf(key);
              tabs.splice(index, 1)
              tabButtonComponent.remove()

              if (index !== 0 && tabs.length > 0){
                handleFileButtonClick(tabs[index-1], tabs[index-1])
              }
              else if (tabs.length > 0) {
                handleFileButtonClick(tabs[0], tabs[0])
                
              }
              else{

                
                view.setState(emptyState);

                states.delete(key)
                consoleView.setState(emptyState);
                commandView.setState(emptyState);
                

                document.getElementById("editor").style.display =  "none"

              }
            
            });

            tabButtonComponent.appendChild(tabOpenButton)
            tabButtonComponent.appendChild(tabCloseButton)

            

            tabElements[0].append(tabButtonComponent)
            

            setFileContentState(fileName, key)
          }


          handleFileButtonClick(fileName, key)
          
        }

        

        function onFileName(msg, ftid) {
          console.log(msg)
          const fileName = msg.fileName // Extract file name from path
          const filePath = msg.filePath
          const key = msg.key

          const directories = filePath.split('/').slice(0, -1)

          var uiElement = $(".sidebar")
          var spacing = 0

          if (directories.length !== 0){

            directories.forEach(directory => {

              if (!directoryMap[directory]){//if directory not rendered yet

                const directoryName = document.createElement("div");
                directoryName.setAttribute("data-directory", directory);
                directoryName.innerHTML = "&#9656; "+directoryName.getAttribute("data-directory");//right
                
                directoryName.style.marginLeft = spacing
                

                const directoryList = document.createElement("sidebar");
                
                
                directoryName.addEventListener("click",
                function() {

                  if (directoryList.style.display === "none") {
                    directoryList.style.display = "block";
                    directoryName.innerHTML = "&#9662; "+directoryName.getAttribute("data-directory");//down
                  } else {
                    directoryList.style.display = "none";
                    directoryName.innerHTML = "&#9656; "+directoryName.getAttribute("data-directory");//right
                  }
                });


                directoryList.style.display = "none";
                uiElement.append(directoryName)
                uiElement.append(directoryList)
                uiElement = directoryList
                directoryMap[directory] = uiElement;

              }

              uiElement = directoryMap[directory]
              spacing += 10
              
            });
          }
          

          const button = document.createElement("div");
          button.textContent = fileName;
          button.className = "fileButton"
          button.style.marginLeft = spacing
          
          button.setAttribute("data-filename", fileName) // Set data attribute for filename
          button.setAttribute("data-key", key)     // Set data attribute for key
          button.addEventListener("click", function() {
              createTabButton(button.getAttribute("data-filename"), button.getAttribute("data-key"))
          });
          
          uiElement.append(button)
        }

        //function called only when tab is rendered for first time or revert is clicked
        function onFileContent(msg, ftid) {

          // Create a new state for the view
          const newState = cm6.createEditorState(msg.code);
          // // Set current state
          // revertState = newState;
          // view.setState(newState);
          states.set(msg.key, newState)
          initStates.set(msg.key, newState)

          console.log("Settng from call")
          view.setState(newState);
          document.getElementById("editor").style.display =  "block"
          
        }

        function revertOriginalContent() {
          setFileContentState(latestFilename, latestKey)
        }

        function saveCurrentContent() {
          const currentCode = view.state.doc.text.join("\n");
          revertState = view.state;

          const changeJson = {
            fileName: latestFilename,
            code: currentCode,
            key: latestKey
          };

          const fileButtons = document.getElementsByClassName("fileButton")

          for (let i=0; i<fileButtons.length; i++){
            if (fileButtons[i].getAttribute("data-key") == latestKey){
              if (fileButtons[i].textContent == "* "+ latestFilename){
                fileButtons[i].textContent = latestFilename
              }
            }
          }

          smq.pubjson(changeJson, "file_overwrite_request");
        }


        function runScript(){
          const currentCode = view.state.doc.text.join("\n");

          const changeJson = {
            fileName: latestFilename,
            code: currentCode,
            key: latestKey
          };

          smq.pubjson(changeJson, "run_script_request");
        }

        function printConsoleOutput(msg, ftid) {
          // Create a new state for the view
          const newState = cm6.createEditorState(msg.output);

          console.log("Received output")
          consoleView.setState(newState);
          
        }

        smq.subscribe("file_names_response", {
          onmsg: onFileName,
          datatype: "json",
        });

        smq.publish("signal", "file_names_request");

        smq.subscribe("file_content_response", {
          onmsg: onFileContent,
          datatype: "json",
        });

        smq.subscribe("console_output", {
          onmsg: printConsoleOutput,
          datatype: "json",
        });

        $("#revert").click(revertOriginalContent);

        $("#save").click(saveCurrentContent);

        $('#run').click(runScript)
      });
    </script>
  </head>
  <body>
    <header class="header">
      <div class="header__content">
        <!-- <a class="logo"> </a> -->

        <nav class="nav">
          <ul class="nav__list">
            <li class="nav__item">
              <a class="nav__link" href=".">Tables</a>
            </li>
            <li class="nav__item">
              <a class="active" href="stim.html">STIM</a>
            </li>
            <li class="nav__item">
              <a class="nav__link" href="chat.html">Chat</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <!-- <div class="editor__body"> -->
      
      <div style="display: flex; height: 100%;">
        <!-- Sidebar -->
        <div style="display: flex; flex-direction: column; align-items: center;">
        <div class="sidebar" ><h3 >Files:</h1></div>
          <button class="btn" id="run">Run</button>
          <button class="btn" id="save">Save</button>
          <button class="btn" id="revert">Revert</button>
        </div>

        <div class="rightPanel">
          <div class="tab">
            <div class="tablinks" style="overflow-x: scroll;">        
            </div>
            <div id="editor"></div>
          </div>
          <div class="bottomContainer">
            <div id="command"></div>
            <div id="console"></div>
          </div>
          </div>

       
        
        
        
      </div>

      
    <!-- </div> -->

    <!-- Codemirror -->
    <script src="editor.bundle.js"></script>
    <script>
      // const statesEl = document.getElementById("states");
      // const saveStateEl = document.getElementById("saveState");
      // const loadStateEl = document.getElementById("loadState");

      // Create an initial state for the ediots
      const initialState = cm6.createEditorState("");

      // Create a editor view for code editor
      const view = cm6.createEditorView(
        initialState,
        document.getElementById("editor")
      );

      // Create a editor view for inserting commands
      const commandView = cm6.createEditorView(
        initialState,
        document.getElementById("command")
      );

      // Create a editor view for viewing results
      const consoleView = cm6.createEditorView(
        initialState,
        document.getElementById("console")
      );

    </script>
  </body>
</html>
